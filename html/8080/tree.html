<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Growing Tree</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f2f2f2;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #121212;
            color: white;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 16px;
        }

        .toggle-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .toggle-button.dark-mode {
            background-color: #555555;
        }
    </style>
</head>
<body>
    <a href="javascript:history.back()" class="back-button">Go Back</a>
    <button class="toggle-button" onclick="toggleDarkMode()">Toggle Dark Mode</button>
    <canvas id="canvas"></canvas>

    <script>
        class Branch {
            constructor(startX, startY, endX, endY, lineWidth, color) {
                this.startX = startX;
                this.startY = startY;
                this.endX = endX;
                this.endY = endY;
                this.color = color;
                this.lineWidth = lineWidth;

                this.frame = 100;
                this.cntFrame = 0;

                this.gapX = (this.endX - this.startX) / this.frame;
                this.gapY = (this.endY - this.startY) / this.frame;

                this.currentX = this.startX;
                this.currentY = this.startY;
            }

            draw(ctx) {
                if (this.cntFrame === this.frame) return true;

                ctx.beginPath();

                this.currentX += this.gapX;
                this.currentY += this.gapY;

                ctx.moveTo(this.startX, this.startY);
                ctx.lineTo(this.currentX, this.currentY);

                ctx.lineWidth = this.lineWidth;
                ctx.strokeStyle = this.color;

                ctx.stroke();
                ctx.closePath();

                this.cntFrame++;

                return false;
            }
        }

        class Tree {
            constructor(ctx, posX, posY, color) {
                this.ctx = ctx;
                this.posX = posX;
                this.posY = posY;
                this.color = color;
                this.branches = [];
                this.depth = 11;

                this.cntDepth = 0;
                this.animation = null;

                this.init();
            }

            init() {
                for (let i = 0; i < this.depth; i++) {
                    this.branches.push([]);
                }

                this.createBranch(this.posX, this.posY, -90, 0);
                this.draw();
            }

            createBranch(startX, startY, angle, depth) {
                if (depth === this.depth) return;

                const len = depth === 0 ? this.random(10, 13) : this.random(0, 11);

                const endX = startX + this.cos(angle) * len * (this.depth - depth);
                const endY = startY + this.sin(angle) * len * (this.depth - depth);

                this.branches[depth].push(
                    new Branch(startX, startY, endX, endY, this.depth - depth, this.color)
                );

                this.createBranch(endX, endY, angle - this.random(15, 23), depth + 1);
                this.createBranch(endX, endY, angle + this.random(15, 23), depth + 1);
            }

            draw() {
                if (this.cntDepth === this.depth) {
                    cancelAnimationFrame(this.animation);
                }

                for (let i = this.cntDepth; i < this.branches.length; i++) {
                    let pass = true;

                    for (let j = 0; j < this.branches[i].length; j++) {
                        pass = this.branches[i][j].draw(this.ctx);
                    }

                    if (!pass) break;
                    this.cntDepth++;
                }

                this.animation = requestAnimationFrame(this.draw.bind(this));
            }

            cos(angle) {
                return Math.cos(this.degToRad(angle));
            }

            sin(angle) {
                return Math.sin(this.degToRad(angle));
            }

            degToRad(angle) {
                return (angle / 180.0) * Math.PI;
            }

            random(min, max) {
                return min + Math.floor(Math.random() * (max - min + 1));
            }
        }

        class App {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.pixelRatio = window.devicePixelRatio > 1 ? 2 : 1;
                this.trees = [];

                window.addEventListener('resize', this.resize.bind(this), false);
                window.addEventListener('click', this.click.bind(this), false);
                this.resize();
            }

            resize() {
                this.stageWidth = document.body.clientWidth;
                this.stageHeight = document.body.clientHeight;

                this.canvas.width = this.stageWidth * this.pixelRatio;
                this.canvas.height = this.stageHeight * this.pixelRatio;
                this.ctx.scale(this.pixelRatio, this.pixelRatio);

                this.ctx.clearRect(0, 0, this.stageWidth, this.stageHeight);

                for (const tree of this.trees) {
                    tree.draw();
                }
            }

            click(event) {
                const { clientX } = event;
                const color = document.body.classList.contains('dark-mode') ? '#FFFFFF' : '#000000';
                const tree = new Tree(this.ctx, clientX, this.stageHeight, color);
                this.trees.push(tree);
            }
        }

        // 쿠키 설정 함수
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        // 쿠키 읽기 함수
        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // 다크 모드 토글 함수
        function toggleDarkMode() {
            const body = document.body;
            const button = document.querySelector('.toggle-button');
            body.classList.toggle('dark-mode');
            button.classList.toggle('dark-mode');
            // Save the current mode to cookie
            if (body.classList.contains('dark-mode')) {
                setCookie('theme', 'dark', 7); // 7일 동안 유효
            } else {
                setCookie('theme', 'light', 7);
            }
            // 페이지를 새로고침하여 변경된 테마를 적용
            location.reload();
        }

        // 페이지 로드 시 쿠키 확인 및 테마 설정
        function applyThemeFromCookie() {
            const savedTheme = getCookie('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const button = document.querySelector('.toggle-button');
                if (button) {
                    button.classList.add('dark-mode');
                }
            }
        }

        // 테마 초기화 및 버튼 이벤트 등록
        window.onload = function() {
            applyThemeFromCookie();
            const button = document.querySelector('.toggle-button');
            if (button) {
                button.onclick = toggleDarkMode;
            }
            new App();
        }
    </script>
</body>
</html>
